<div class="animate-fade-in font-sans pb-12">
    <!-- Header -->
    <header class="mb-8 flex justify-between items-center">
        <div>
            <h2 class="text-3xl font-bold text-slate-900 mb-1">Resoluções Guiadas</h2>
            <p class="text-slate-500 text-sm">Aprenda a pensar sobre cada questão da ETEC.</p>
        </div>
        @if (viewState() !== 'selection') {
        <button (click)="goBack()"
            class="flex items-center text-slate-500 hover:text-black transition-colors text-sm font-medium">
            <i class="fas fa-arrow-left mr-2"></i> Voltar
        </button>
        }
    </header>

    <!-- 1. Selection State -->
    @if (viewState() === 'selection') {
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Mode Selection -->
        <div class="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm">
            <h3 class="font-bold text-slate-900 mb-6 flex items-center">
                <i class="fas fa-layer-group mr-2 text-slate-400"></i> Escolha o módulo
            </h3>
            <div class="space-y-3">
                <button (click)="selectMode('quiz')"
                    class="w-full p-4 rounded-xl border-2 text-left transition-all flex items-center justify-between group"
                    [class.border-black]="selectedMode() === 'quiz'" [class.bg-slate-50]="selectedMode() === 'quiz'"
                    [class.border-slate-100]="selectedMode() !== 'quiz'"
                    [class.hover:border-slate-200]="selectedMode() !== 'quiz'">
                    <div>
                        <p class="font-bold text-slate-900">Simulados</p>
                        <p class="text-xs text-slate-500">Questões do banco padrão</p>
                    </div>
                    <i class="fas fa-chevron-right text-slate-300 group-hover:text-black transition-colors"></i>
                </button>
                <button (click)="selectMode('interpretation')"
                    class="w-full p-4 rounded-xl border-2 text-left transition-all flex items-center justify-between group"
                    [class.border-black]="selectedMode() === 'interpretation'"
                    [class.bg-slate-50]="selectedMode() === 'interpretation'"
                    [class.border-slate-100]="selectedMode() !== 'interpretation'"
                    [class.hover:border-slate-200]="selectedMode() !== 'interpretation'">
                    <div>
                        <p class="font-bold text-slate-900">Interpretação</p>
                        <p class="text-xs text-slate-500">Textos e gramática aplicada</p>
                    </div>
                    <i class="fas fa-chevron-right text-slate-300 group-hover:text-black transition-colors"></i>
                </button>
            </div>
        </div>

        <!-- Filter Selection -->
        <div class="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm" [class.opacity-50]="!selectedMode()"
            [class.pointer-events-none]="!selectedMode()">
            <h3 class="font-bold text-slate-900 mb-6 flex items-center">
                <i class="fas fa-filter mr-2 text-slate-400"></i> O que você quer revisar?
            </h3>
            <div class="grid grid-cols-1 gap-3">
                <button (click)="selectFilter('wrong')"
                    class="p-4 rounded-xl bg-red-50 text-red-700 font-bold text-sm hover:bg-red-100 transition-colors flex items-center justify-between">
                    Minhas incorretas <i class="fas fa-times-circle"></i>
                </button>
                <button (click)="selectFilter('correct')"
                    class="p-4 rounded-xl bg-green-50 text-green-700 font-bold text-sm hover:bg-green-100 transition-colors flex items-center justify-between">
                    Minhas corretas <i class="fas fa-check-circle"></i>
                </button>
                <button (click)="selectFilter('new')"
                    class="p-4 rounded-xl bg-blue-50 text-blue-700 font-bold text-sm hover:bg-blue-100 transition-colors flex items-center justify-between">
                    Questões inéditas <i class="fas fa-star"></i>
                </button>
                <button (click)="selectFilter('random')"
                    class="p-4 rounded-xl bg-slate-100 text-slate-700 font-bold text-sm hover:bg-slate-200 transition-colors flex items-center justify-between">
                    Qualquer uma (Aleatório) <i class="fas fa-random"></i>
                </button>
            </div>
        </div>
    </div>
    }

    <!-- 2. List State -->
    @if (viewState() === 'list') {
    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">
        <div class="p-6 border-b border-slate-100 bg-slate-50 flex justify-between items-center">
            <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">
                Encontradas: {{ filteredQuestions().length }} questões
            </span>
        </div>
        <div class="divide-y divide-slate-100 max-h-[600px] overflow-y-auto">
            @for (q of filteredQuestions(); track q.id) {
            <button (click)="openResolution(q)"
                class="w-full p-6 text-left hover:bg-slate-50 transition-colors flex items-center group">
                <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="text-[10px] font-bold bg-slate-100 px-2 py-0.5 rounded uppercase">{{ q.subject
                            }}</span>
                        <span class="text-[10px] font-bold px-2 py-0.5 rounded uppercase"
                            [class.bg-green-100]="q.difficulty === 'Fácil'"
                            [class.bg-yellow-100]="q.difficulty === 'Médio'"
                            [class.bg-red-100]="q.difficulty === 'Difícil'">{{ q.difficulty }}</span>
                    </div>
                    <p class="text-slate-800 font-medium line-clamp-2 text-sm">{{ q.text }}</p>
                </div>
                <i class="fas fa-arrow-right text-slate-300 group-hover:text-black transition-colors ml-4"></i>
            </button>
            }
        </div>
    </div>
    }

    <!-- 3. Viewer State (Guia Mental) -->
    @if (viewState() === 'viewer') {
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 items-start">
        <!-- Left: Question & Alternatives -->
        <div class="bg-white p-8 rounded-2xl border border-slate-200 shadow-sm sticky top-8">
            <div class="flex items-center gap-3 mb-6">
                <span class="text-xs font-bold bg-slate-100 px-3 py-1 rounded-full text-slate-600 uppercase">{{
                    currentQuestion()?.subject }}</span>
                <span class="text-xs font-bold bg-black text-white px-3 py-1 rounded-full uppercase">QUESTÃO {{
                    currentQuestion()?.id }}</span>
            </div>

            <!-- Reference/Support Text -->
            @if (currentQuestion()?.supportText) {
            <div class="bg-slate-50 p-6 rounded-xl border border-slate-100 mb-8 max-h-64 overflow-y-auto italic text-slate-600 text-sm leading-relaxed whitespace-pre-wrap"
                [innerHTML]="currentQuestion()?.supportText | latex">
            </div>
            }

            <div class="prose prose-slate max-w-none text-slate-800 font-medium mb-8"
                [innerHTML]="currentQuestion()?.text | latex"></div>

            <div class="space-y-3">
                @for (option of currentQuestion()?.options; track $index) {
                <div class="p-4 rounded-xl border-2 transition-all flex items-start text-sm"
                    [class.border-green-500]="showCorrectAnswer() && $index === currentQuestion()?.correctIndex"
                    [class.bg-green-50]="showCorrectAnswer() && $index === currentQuestion()?.correctIndex"
                    [class.border-slate-100]="!showCorrectAnswer() || $index !== currentQuestion()?.correctIndex">
                    <span class="w-6 h-6 rounded-full flex items-center justify-center font-bold mr-4 shrink-0 text-xs"
                        [class.bg-slate-100]="!showCorrectAnswer() || $index !== currentQuestion()?.correctIndex"
                        [class.bg-green-500]="showCorrectAnswer() && $index === currentQuestion()?.correctIndex"
                        [class.text-white]="showCorrectAnswer() && $index === currentQuestion()?.correctIndex">
                        {{ getOptionLetter($index) }}
                    </span>
                    <span [innerHTML]="option | latex"></span>
                </div>
                }
            </div>
        </div>

        <!-- Right: Progressive Mental Steps -->
        <div class="space-y-6">
            <div class="bg-black text-white p-8 rounded-2xl shadow-xl">
                <h3 class="font-bold text-xl mb-6 flex items-center">
                    <i class="fas fa-brain mr-4 text-slate-400"></i> Guia Mental da Questão
                </h3>

                @if (!currentResolution()) {
                <div class="p-6 bg-white/10 rounded-xl border border-white/10 text-center">
                    <i class="fas fa-robot text-3xl mb-4 text-slate-400"></i>
                    <p class="text-sm text-slate-300">Resolução automatizada via IA sendo gerada para esta questão.</p>
                </div>
                } @else {
                <div class="space-y-6 relative">
                    <!-- Steps List -->
                    @for (step of currentResolution()?.steps; track $index) {
                    @if ($index < visibleStepsCount()) { <div class="animate-fade-in-up">
                        <div class="flex items-start gap-4 mb-2">
                            <div class="w-1.5 h-1.5 rounded-full bg-slate-400 mt-2 shrink-0"></div>
                            <p class="font-bold text-slate-100 text-sm">{{ step.title }}</p>
                        </div>
                        <div
                            class="ml-5 p-4 bg-white/5 rounded-xl border border-white/5 text-sm text-slate-300 leading-relaxed">
                            {{ step.content }}
                        </div>
                </div>
                }
                }

                <!-- Conclusion / Correct Answer -->
                @if (showCorrectAnswer()) {
                <div class="animate-bounce-in mt-8 p-6 bg-green-500/20 border border-green-500/30 rounded-2xl">
                    <div class="flex items-center gap-4 mb-3">
                        <div class="w-10 h-10 rounded-full bg-green-500 flex items-center justify-center text-white">
                            <i class="fas fa-check"></i>
                        </div>
                        <p class="font-bold text-white uppercase tracking-widest text-sm">Resposta Definitiva</p>
                    </div>
                    <p class="text-2xl font-black text-white ml-14">
                        Alternativa {{ getOptionLetter(currentQuestion()?.correctIndex || 0) }}
                    </p>
                    @if (currentQuestion()?.explanation) {
                    <div class="mt-4 pt-4 border-t border-white/10 text-sm text-green-100 italic"
                        [innerHTML]="currentQuestion()?.explanation | latex"></div>
                    }
                </div>
                }
            </div>

            <!-- Action Button -->
            <div class="mt-8">
                <button (click)="revealNextStep()" [disabled]="showCorrectAnswer()"
                    class="w-full py-4 rounded-xl font-bold transition-all flex items-center justify-center gap-3"
                    [class.bg-white]="!showCorrectAnswer()" [class.text-black]="!showCorrectAnswer()"
                    [class.bg-slate-800]="showCorrectAnswer()" [class.text-slate-500]="showCorrectAnswer()"
                    [class.hover:scale-105]="!showCorrectAnswer()">
                    @if (visibleStepsCount() === 0) {
                    <span>Começar Raciocínio</span>
                    } @else if (!showCorrectAnswer()) {
                    <span>{{ visibleStepsCount() < (currentResolution()?.steps?.length || 0) ? 'Próximo Passo'
                            : 'Ver Gabarito' }}</span>
                            } @else {
                            <span>Resolução Concluída</span>
                            }
                            @if (!showCorrectAnswer()) { <i class="fas fa-chevron-right text-xs"></i> }
                </button>
            </div>
            }
        </div>

        <!-- Tip Card -->
        <div class="bg-blue-50 border border-blue-100 p-6 rounded-2xl flex gap-4">
            <i class="fas fa-info-circle text-blue-400 text-xl"></i>
            <p class="text-sm text-blue-700 leading-relaxed">
                **Dica:** Tente pensar por conta própria a cada passo revelado antes de pular para o próximo. O objetivo
                é treinar seu cérebro para o dia da prova!
            </p>
        </div>
    </div>
</div>
}

<!-- 4. Empty State -->
@if (viewState() === 'empty') {
<div class="bg-white p-12 rounded-3xl border border-slate-100 shadow-sm text-center max-w-lg mx-auto">
    <div class="w-20 h-20 bg-slate-50 rounded-full flex items-center justify-center mx-auto mb-6 text-slate-300">
        <i class="fas fa-search text-3xl"></i>
    </div>
    <h3 class="text-xl font-bold text-slate-900 mb-2">Nenhuma questão encontrada</h3>
    <p class="text-slate-500 text-sm mb-8">Não encontramos questões neste filtro para este módulo. Comece a fazer
        simulados ou atividades de interpretação para gerar histórico!</p>
    <button (click)="goBack()"
        class="bg-black text-white px-8 py-3 rounded-xl font-bold text-sm hover:scale-105 transition-all">
        Voltar e tentar outro
    </button>
</div>
}
</div>