<div class="interpretation-container">

  <!-- LOADING STATE -->
  @if (viewState() === 'loading') {
  <div class="loading-state">
    <div class="spinner"></div>
    <p>Carregando textos de interpretação...</p>
  </div>
  }

  <!-- ERROR STATE -->
  @else if (viewState() === 'error') {
  <div class="error-state">
    <i class="fas fa-exclamation-triangle"></i>
    <h3>Erro ao Carregar</h3>
    <p>{{ errorMessage() }}</p>
    <button (click)="ngOnInit()" class="retry-button">Tentar Novamente</button>
  </div>
  }

  <!-- CONFIG / START SCREEN -->
  @else if (viewState() === 'config') {
  <div class="config-screen">
    <div class="config-card">
      <div class="config-header">
        <i class="fas fa-book-open"></i>
        <h2>Interpretação de Texto</h2>
        <p>Configure sua atividade</p>
      </div>

      <div class="config-form">
        <!-- Dificuldade -->
        <div class="form-group">
          <label>
            <i class="fas fa-signal"></i>
            Nível de Dificuldade
          </label>
          <div class="difficulty-selector">
            <button class="difficulty-btn" [class.active]="selectedDifficulty() === 'Fácil'"
              (click)="selectedDifficulty.set('Fácil')">
              <i class="fas fa-smile"></i>
              Fácil
            </button>
            <button class="difficulty-btn" [class.active]="selectedDifficulty() === 'Médio'"
              (click)="selectedDifficulty.set('Médio')">
              <i class="fas fa-meh"></i>
              Médio
            </button>
            <button class="difficulty-btn" [class.active]="selectedDifficulty() === 'Difícil'"
              (click)="selectedDifficulty.set('Difícil')">
              <i class="fas fa-frown"></i>
              Difícil
            </button>
            <button class="difficulty-btn" [class.active]="selectedDifficulty() === 'Todas'"
              (click)="selectedDifficulty.set('Todas')">
              <i class="fas fa-layer-group"></i>
              Todas
            </button>
          </div>
        </div>

        <!-- Número de Questões -->
        <div class="form-group">
          <label>
            <i class="fas fa-list-ol"></i>
            Número de Questões por Texto
          </label>
          <div class="question-count-selector">
            <button class="count-btn" [class.active]="selectedQuestionCount() === 1"
              (click)="selectedQuestionCount.set(1)">
              1
            </button>
            <button class="count-btn" [class.active]="selectedQuestionCount() === 2"
              (click)="selectedQuestionCount.set(2)">
              2
            </button>
            <button class="count-btn" [class.active]="selectedQuestionCount() === 3"
              (click)="selectedQuestionCount.set(3)">
              3
            </button>
          </div>
          <small class="hint">
            <i class="fas fa-info-circle"></i>
            Cada texto terá {{ selectedQuestionCount() }} questão(ões) para responder
          </small>
        </div>

        <!-- Start Button -->
        <button class="start-button" (click)="startActivity()">
          <i class="fas fa-play"></i>
          Iniciar Atividade
        </button>
      </div>
    </div>
  </div>
  }

  <!-- ACTIVITY SCREEN (uma questão por vez) -->
  @else if (viewState() === 'activity' && currentQuestion(); as question) {
  <div class="activity-screen">

    <!-- Progress Header -->
    <div class="progress-header">
      <button class="back-btn" (click)="backToConfig()">
        <i class="fas fa-arrow-left"></i>
        Voltar
      </button>
      <div class="progress-info">
        <span class="progress-text">{{ getProgress() }}</span>
        <div class="score-display">
          <i class="fas fa-check-circle"></i>
          {{ totalCorrect() }}/{{ totalAnswered() }}
        </div>
      </div>
    </div>

    <!-- Support Text (Texto de Referência) -->
    <div class="support-text-card">
      <div class="support-text-header">
        <i class="fas fa-file-alt"></i>
        <h3>Texto de Referência</h3>
      </div>
      <div class="text-content" [innerHTML]="currentGroup().supportText | latex"></div>
    </div>

    <!-- Questão Atual -->
    <div class="question-card">
      <div class="question-header">
        <h4>
          <i class="fas fa-question-circle"></i>
          Questão {{ currentQuestionIndex() + 1 }}
        </h4>
        <span class="difficulty-badge" [class]="'difficulty-' + question.difficulty.toLowerCase()">
          {{ question.difficulty }}
        </span>
      </div>

      <p class="question-text" [innerHTML]="question.text | latex"></p>

      <!-- Options -->
      <div class="options-list">
        @for (option of question.options; track $index) {
        <label class="option-item" [class.selected]="isSelected($index)" [class.correct]="isCorrectOption($index)"
          [class.wrong]="isWrongOption($index)" [class.disabled]="hasAnswered()">
          <input type="radio" [name]="'current-question'" [value]="$index" [checked]="isSelected($index)"
            [disabled]="hasAnswered()" (change)="selectAnswer($index)">
          <span class="option-letter">{{ getOptionLetter($index) }}</span>
          <span class="option-text" [innerHTML]="option | latex"></span>
          @if (isCorrectOption($index)) {
          <i class="fas fa-check-circle result-icon"></i>
          }
          @if (isWrongOption($index)) {
          <i class="fas fa-times-circle result-icon"></i>
          }
        </label>
        }
      </div>

      <!-- Explanation (após verificar) -->
      @if (hasAnswered() && question.explanation) {
      <div class="explanation-box" [@slideDown]>
        <div class="explanation-header">
          <i class="fas fa-lightbulb"></i>
          <strong>Explicação</strong>
        </div>
        <p [innerHTML]="question.explanation | latex"></p>
      </div>
      }

      <!-- Feedback Banner -->
      @if (hasAnswered()) {
      <div class="feedback-banner" [class.correct]="isCorrect()" [class.wrong]="!isCorrect()">
        @if (isCorrect()) {
        <i class="fas fa-check-circle"></i>
        <span>Correto! Parabéns!</span>
        } @else {
        <i class="fas fa-times-circle"></i>
        <span>Incorreto. Veja a explicação acima.</span>
        }
      </div>
      }
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
      @if (!hasAnswered()) {
      <button class="btn-primary" [disabled]="!canVerify()" (click)="verifyAnswer()">
        <i class="fas fa-check"></i>
        Verificar Resposta
      </button>
      } @else {
      <button class="btn-primary" (click)="nextQuestion()">
        Próxima Questão
        <i class="fas fa-arrow-right"></i>
      </button>
      }
    </div>
  </div>
  }

  <!-- Empty State -->
  @else {
  <div class="empty-state">
    <i class="fas fa-inbox"></i>
    <h3>Nenhum texto disponível</h3>
    <p>Não há textos de interpretação cadastrados no momento.</p>
    <button class="retry-button" (click)="backToConfig()">
      <i class="fas fa-arrow-left"></i>
      Voltar
    </button>
  </div>
  }

</div>